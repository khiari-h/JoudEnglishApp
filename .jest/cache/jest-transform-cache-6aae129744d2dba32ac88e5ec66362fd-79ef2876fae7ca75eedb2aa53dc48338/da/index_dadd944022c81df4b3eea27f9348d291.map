{"version":3,"names":["_react","require","_expoRouter","_asyncStorage","_interopRequireDefault","_RevisionPopup","_jsxRuntime","REVISION_STORAGE_KEY","RevisionOrchestrator","_ref","_ref$currentLevel","currentLevel","_useState","useState","_useState2","_slicedToArray2","default","showPopup","setShowPopup","_useState3","_useState4","totalWords","setTotalWords","_useState5","_useState6","nextRevisionAt","setNextRevisionAt","_useState7","_useState8","isDisabled","setIsDisabled","_useState9","_useState0","isLoaded","setIsLoaded","popupShownRef","useRef","countWords","_ref2","_asyncToGenerator2","total","levels","modes","level","mode","stored","AsyncStorage","getItem","data","JSON","parse","completedWords","Object","values","reduce","acc","words","Array","isArray","length","error","apply","arguments","loadRevisionPreferences","_ref3","saved","prefs","console","saveRevisionPreferences","_ref4","newNextAt","newIsDisabled","lastUpdate","Date","now","setItem","stringify","_x","_x2","useEffect","initializeRevision","_ref5","shouldShow","current","setTimeout","handleChoice","useCallback","_ref6","choice","nextTarget","router","push","pathname","params","questionsCount","source","next50","next100","defaultNext","_x3","handleDismiss","jsx","visible","totalWordsLearned","onChoice","onDismiss","_default","exports"],"sources":["index.js"],"sourcesContent":["// src/components/revision/RevisionOrchestrator/index.js - VERSION CORRIGÉE\r\nimport { useEffect, useState, useRef, useCallback } from 'react';\r\nimport { router } from 'expo-router';\r\nimport AsyncStorage from '@react-native-async-storage/async-storage';\r\nimport RevisionPopup from '../../Dashboard/components/popup/RevisionPopup';\r\n\r\nconst REVISION_STORAGE_KEY = 'revision_preferences';\r\n\r\nconst RevisionOrchestrator = ({ currentLevel = \"mixed\" }) => {\r\n  const [showPopup, setShowPopup] = useState(false);\r\n  const [totalWords, setTotalWords] = useState(0);\r\n  const [nextRevisionAt, setNextRevisionAt] = useState(50);\r\n  const [isDisabled, setIsDisabled] = useState(false); // ✅ VRAI FLAG BOOLEAN\r\n  const [isLoaded, setIsLoaded] = useState(false);\r\n  \r\n  // ✅ PROTECTION contre double-popup\r\n  const popupShownRef = useRef(false);\r\n\r\n  // ========== COMPTAGE SIMPLE ==========\r\n  const countWords = async () => {\r\n    try {\r\n      let total = 0;\r\n      const levels = ['1', '2', '3', '4', '5', '6', 'bonus'];\r\n      const modes = ['classic', 'fast'];\r\n\r\n      for (const level of levels) {\r\n        for (const mode of modes) {\r\n          const stored = await AsyncStorage.getItem(`vocabulary_${level}_${mode}`);\r\n          if (stored) {\r\n            const data = JSON.parse(stored);\r\n            const completedWords = data.completedWords || {};\r\n            total += Object.values(completedWords).reduce((acc, words) => {\r\n              if (Array.isArray(words)) {\r\n                return acc + words.length;\r\n              }\r\n              return acc;\r\n            }, 0);\r\n          }\r\n        }\r\n      }\r\n\r\n      setTotalWords(total);\r\n      return total;\r\n    } catch (error) {\r\n      return 0;\r\n    }\r\n  };\r\n\r\n  // ========== SAUVEGARDE/CHARGEMENT CORRIGÉ ==========\r\n  const loadRevisionPreferences = async () => {\r\n    try {\r\n      const saved = await AsyncStorage.getItem(REVISION_STORAGE_KEY);\r\n      if (saved) {\r\n        const prefs = JSON.parse(saved);\r\n        setNextRevisionAt(prefs.nextRevisionAt || 50);\r\n        setIsDisabled(prefs.isDisabled || false); // ✅ VRAI FLAG\r\n      } else {\r\n        // ✅ Valeurs par défaut\r\n        setNextRevisionAt(50);\r\n        setIsDisabled(false);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading revision preferences:', error);\r\n      setNextRevisionAt(50);\r\n      setIsDisabled(false);\r\n    } finally {\r\n      setIsLoaded(true);\r\n    }\r\n  };\r\n\r\n  const saveRevisionPreferences = async (newNextAt, newIsDisabled) => {\r\n    try {\r\n      const prefs = {\r\n        nextRevisionAt: newNextAt,\r\n        isDisabled: newIsDisabled,\r\n        lastUpdate: Date.now()\r\n      };\r\n      \r\n      await AsyncStorage.setItem(REVISION_STORAGE_KEY, JSON.stringify(prefs));\r\n      \r\n      setNextRevisionAt(newNextAt);\r\n      setIsDisabled(newIsDisabled);\r\n    } catch (error) {\r\n      console.error('Error saving revision preferences:', error);\r\n    }\r\n  };\r\n\r\n  // ========== CHARGEMENT INITIAL ==========\r\n  useEffect(() => {\r\n    const initializeRevision = async () => {\r\n      await loadRevisionPreferences();\r\n      await countWords();\r\n    };\r\n\r\n    initializeRevision();\r\n  }, []);\r\n\r\n  // ========== VÉRIFICATION RÉVISION ==========\r\n  useEffect(() => {\r\n    // ✅ ATTENDRE que tout soit chargé\r\n    if (!isLoaded) return;\r\n    \r\n    // ✅ VÉRIFICATION COMPLÈTE\r\n    const shouldShow = !isDisabled && \r\n                      totalWords >= nextRevisionAt && \r\n                      totalWords > 0 && \r\n                      !showPopup && \r\n                      !popupShownRef.current;\r\n\r\n    if (shouldShow) {\r\n      // ✅ PROTECTION double-popup\r\n      popupShownRef.current = true;\r\n      setTimeout(() => setShowPopup(true), 1000);\r\n    }\r\n  }, [isLoaded, isDisabled, totalWords, nextRevisionAt, showPopup]);\r\n\r\n  // ========== HANDLERS CORRIGÉS ==========\r\n  const handleChoice = useCallback(async (choice) => {\r\n    setShowPopup(false);\r\n    popupShownRef.current = false; // ✅ Reset protection\r\n    \r\n    switch (choice) {\r\n      case 'now': {\r\n        // ✅ Programmer prochaine révision AVANT navigation\r\n        const nextTarget = totalWords + 50;\r\n        await saveRevisionPreferences(nextTarget, false);\r\n        // Navigation\r\n        router.push({\r\n          pathname: \"/tabs/vocabularyRevision\",\r\n          params: {\r\n            level: currentLevel,\r\n            questionsCount: 10,\r\n            source: 'popup_trigger'\r\n          }\r\n        });\r\n        break;\r\n      }\r\n      case 'later_50': {\r\n        const next50 = totalWords + 50;\r\n        await saveRevisionPreferences(next50, false);\r\n        break;\r\n      }\r\n      case 'later_100': {\r\n        const next100 = totalWords + 100;\r\n        await saveRevisionPreferences(next100, false);\r\n        break;\r\n      }\r\n      case 'disable': {\r\n        // ✅ VRAIE DÉSACTIVATION\r\n        await saveRevisionPreferences(nextRevisionAt, true); // ✅ isDisabled = true\r\n        break;\r\n      }\r\n      default: {\r\n        // Fermeture = later_50 par défaut\r\n        const defaultNext = totalWords + 50;\r\n        await saveRevisionPreferences(defaultNext, false);\r\n        break;\r\n      }\r\n    }\r\n  }, [totalWords, saveRevisionPreferences, currentLevel, nextRevisionAt]);\r\n\r\n  const handleDismiss = useCallback(() => handleChoice('later_50'), [handleChoice]);\r\n\r\n  // ✅ NE PAS RENDRE SI DISABLED\r\n  if (isDisabled) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <RevisionPopup\r\n      visible={showPopup}\r\n      totalWordsLearned={totalWords}\r\n      questionsCount={10}\r\n      currentLevel={currentLevel}\r\n      onChoice={handleChoice}\r\n      onDismiss={handleDismiss}\r\n    />\r\n  );\r\n};\r\n\r\nexport default RevisionOrchestrator;"],"mappings":"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","ignoreList":[]}
{"version":3,"names":["_interopRequireDefault","require","Object","defineProperty","exports","value","NativeEventsManager","_classCallCheck2","_createClass2","_classPrivateFieldLooseBase2","_classPrivateFieldLooseKey2","_utils","_WorkletEventHandler","_findNodeHandle4","_managedComponent","default","_componentOptions","_eventViewTag","component","options","writable","getEventViewTag","key","attachEvents","_this","executeForEachEventHandler","props","handler","registerForEvents","detachEvents","_this2","_key","unregisterFromEvents","updateEvents","prevProps","_this3","computedEventTag","prevHandler","newProp","isWorkletEventHandler","workletEventHandler","_classPrivateFieldLoo","_findNodeHandle3","componentUpdate","arguments","length","undefined","componentAnimatedRef","_componentRef","getScrollableNode","_findNodeHandle","scrollableNode","findNodeHandle","setNativeProps","_findNodeHandle2","getComponentViewTag","__nativeTag","_nativeTag","_ref","_componentAnimatedRef","prop","has","WorkletEventHandler","callback"],"sources":["NativeEventsManager.ts"],"sourcesContent":["'use strict';\nimport type {\n  INativeEventsManager,\n  IAnimatedComponentInternal,\n  AnimatedComponentProps,\n  InitialComponentProps,\n  AnimatedComponentRef,\n} from './commonTypes';\nimport { has } from './utils';\nimport { WorkletEventHandler } from '../WorkletEventHandler';\nimport { findNodeHandle } from '../platformFunctions/findNodeHandle';\n\nexport class NativeEventsManager implements INativeEventsManager {\n  readonly #managedComponent: ManagedAnimatedComponent;\n  readonly #componentOptions?: ComponentOptions;\n  #eventViewTag = -1;\n\n  constructor(component: ManagedAnimatedComponent, options?: ComponentOptions) {\n    this.#managedComponent = component;\n    this.#componentOptions = options;\n    this.#eventViewTag = this.getEventViewTag();\n  }\n\n  public attachEvents() {\n    executeForEachEventHandler(this.#managedComponent.props, (key, handler) => {\n      handler.registerForEvents(this.#eventViewTag, key);\n    });\n  }\n\n  public detachEvents() {\n    executeForEachEventHandler(\n      this.#managedComponent.props,\n      (_key, handler) => {\n        handler.unregisterFromEvents(this.#eventViewTag);\n      }\n    );\n  }\n\n  public updateEvents(\n    prevProps: AnimatedComponentProps<InitialComponentProps>\n  ) {\n    const computedEventTag = this.getEventViewTag(true);\n    // If the event view tag changes, we need to completely re-mount all events\n    if (this.#eventViewTag !== computedEventTag) {\n      // Remove all bindings from previous props that ran on the old viewTag\n      executeForEachEventHandler(prevProps, (_key, handler) => {\n        handler.unregisterFromEvents(this.#eventViewTag);\n      });\n      // We don't need to unregister from current (new) props, because their events weren't registered yet\n      // Replace the view tag\n      this.#eventViewTag = computedEventTag;\n      // Attach the events with a new viewTag\n      this.attachEvents();\n      return;\n    }\n\n    executeForEachEventHandler(prevProps, (key, prevHandler) => {\n      const newProp = this.#managedComponent.props[key];\n      if (!newProp) {\n        // Prop got deleted\n        prevHandler.unregisterFromEvents(this.#eventViewTag);\n      } else if (\n        isWorkletEventHandler(newProp) &&\n        newProp.workletEventHandler !== prevHandler\n      ) {\n        // Prop got changed\n        prevHandler.unregisterFromEvents(this.#eventViewTag);\n        newProp.workletEventHandler.registerForEvents(this.#eventViewTag);\n      }\n    });\n\n    executeForEachEventHandler(this.#managedComponent.props, (key, handler) => {\n      if (!prevProps[key]) {\n        // Prop got added\n        handler.registerForEvents(this.#eventViewTag);\n      }\n    });\n  }\n\n  private getEventViewTag(componentUpdate: boolean = false) {\n    // Get the tag for registering events - since the event emitting view can be nested inside the main component\n    const componentAnimatedRef = this.#managedComponent\n      ._componentRef as AnimatedComponentRef & {\n      // Fabric\n      __nativeTag?: number;\n      // Paper\n      _nativeTag?: number;\n    };\n    if (componentAnimatedRef.getScrollableNode) {\n      /*\n        In most cases, getScrollableNode() returns a view tag, and findNodeHandle is not required. \n        However, to cover more exotic list cases, we will continue to use findNodeHandle \n        for consistency. For numerical values, findNodeHandle should return the value immediately, \n        as documented here: https://github.com/facebook/react/blob/91061073d57783c061889ac6720ef1ab7f0c2149/packages/react-native-renderer/src/ReactNativePublicCompat.js#L113\n      */\n      const scrollableNode = componentAnimatedRef.getScrollableNode();\n      if (typeof scrollableNode === 'number') {\n        return scrollableNode;\n      }\n      return findNodeHandle(scrollableNode) ?? -1;\n    }\n    if (this.#componentOptions?.setNativeProps) {\n      // This case ensures backward compatibility with components that\n      // have their own setNativeProps method passed as an option.\n      return findNodeHandle(this.#managedComponent) ?? -1;\n    }\n    if (!componentUpdate) {\n      // On the first render of a component, we may already receive a resolved view tag.\n      return this.#managedComponent.getComponentViewTag();\n    }\n    if (componentAnimatedRef.__nativeTag || componentAnimatedRef._nativeTag) {\n      /*\n        Fast path for native refs,\n        _nativeTag is used by Paper components,\n        __nativeTag is used by Fabric components.\n      */\n      return (\n        componentAnimatedRef.__nativeTag ??\n        componentAnimatedRef._nativeTag ??\n        -1\n      );\n    }\n    /*\n      When a component is updated, a child could potentially change and have a different \n      view tag. This can occur with a GestureDetector component.\n    */\n    return findNodeHandle(componentAnimatedRef) ?? -1;\n  }\n}\n\nfunction isWorkletEventHandler(\n  prop: unknown\n): prop is WorkletEventHandlerHolder {\n  return (\n    has('workletEventHandler', prop) &&\n    prop.workletEventHandler instanceof WorkletEventHandler\n  );\n}\n\nfunction executeForEachEventHandler(\n  props: AnimatedComponentProps<InitialComponentProps>,\n  callback: (\n    key: string,\n    handler: InstanceType<typeof WorkletEventHandler>\n  ) => void\n) {\n  for (const key in props) {\n    const prop = props[key];\n    if (isWorkletEventHandler(prop)) {\n      callback(key, prop.workletEventHandler);\n    }\n  }\n}\n\ntype ManagedAnimatedComponent = React.Component<\n  AnimatedComponentProps<InitialComponentProps>\n> &\n  IAnimatedComponentInternal;\n\ntype ComponentOptions = {\n  setNativeProps: (\n    ref: AnimatedComponentRef,\n    props: InitialComponentProps\n  ) => void;\n};\n\ntype WorkletEventHandlerHolder = {\n  workletEventHandler: InstanceType<typeof WorkletEventHandler>;\n};\n"],"mappings":"AAAA,YAAY;;AAAC,IAAAA,sBAAA,GAAAC,OAAA;AAAAC,MAAA,CAAAC,cAAA,CAAAC,OAAA;EAAAC,KAAA;AAAA;AAAAD,OAAA,CAAAE,mBAAA;AAAA,IAAAC,gBAAA,GAAAP,sBAAA,CAAAC,OAAA;AAAA,IAAAO,aAAA,GAAAR,sBAAA,CAAAC,OAAA;AAAA,IAAAQ,4BAAA,GAAAT,sBAAA,CAAAC,OAAA;AAAA,IAAAS,2BAAA,GAAAV,sBAAA,CAAAC,OAAA;AAQb,IAAAU,MAAA,GAAAV,OAAA;AACA,IAAAW,oBAAA,GAAAX,OAAA;AACA,IAAAY,gBAAA,GAAAZ,OAAA;AAAqE,IAAAa,iBAAA,OAAAJ,2BAAA,CAAAK,OAAA;AAAA,IAAAC,iBAAA,OAAAN,2BAAA,CAAAK,OAAA;AAAA,IAAAE,aAAA,OAAAP,2BAAA,CAAAK,OAAA;AAAA,IAExDT,mBAAmB,GAAAF,OAAA,CAAAE,mBAAA;EAK9B,SAAAA,oBAAYY,SAAmC,EAAEC,OAA0B,EAAE;IAAA,IAAAZ,gBAAA,CAAAQ,OAAA,QAAAT,mBAAA;IAAAJ,MAAA,CAAAC,cAAA,OAAAW,iBAAA;MAAAM,QAAA;MAAAf,KAAA;IAAA;IAAAH,MAAA,CAAAC,cAAA,OAAAa,iBAAA;MAAAI,QAAA;MAAAf,KAAA;IAAA;IAAAH,MAAA,CAAAC,cAAA,OAAAc,aAAA;MAAAG,QAAA;MAAAf,KAAA,EAF7D,CAAC;IAAC;IAGhB,IAAAI,4BAAA,CAAAM,OAAA,MAAI,EAAAD,iBAAA,EAAAA,iBAAA,IAAqBI,SAAS;IAClC,IAAAT,4BAAA,CAAAM,OAAA,MAAI,EAAAC,iBAAA,EAAAA,iBAAA,IAAqBG,OAAO;IAChC,IAAAV,4BAAA,CAAAM,OAAA,MAAI,EAAAE,aAAA,EAAAA,aAAA,IAAiB,IAAI,CAACI,eAAe,CAAC,CAAC;EAC7C;EAAC,WAAAb,aAAA,CAAAO,OAAA,EAAAT,mBAAA;IAAAgB,GAAA;IAAAjB,KAAA,EAED,SAAOkB,YAAYA,CAAA,EAAG;MAAA,IAAAC,KAAA;MACpBC,0BAA0B,CAAC,IAAAhB,4BAAA,CAAAM,OAAA,MAAI,EAAAD,iBAAA,EAAAA,iBAAA,EAAmBY,KAAK,EAAE,UAACJ,GAAG,EAAEK,OAAO,EAAK;QACzEA,OAAO,CAACC,iBAAiB,KAAAnB,4BAAA,CAAAM,OAAA,EAACS,KAAI,EAAAP,aAAA,EAAAA,aAAA,GAAgBK,GAAG,CAAC;MACpD,CAAC,CAAC;IACJ;EAAC;IAAAA,GAAA;IAAAjB,KAAA,EAED,SAAOwB,YAAYA,CAAA,EAAG;MAAA,IAAAC,MAAA;MACpBL,0BAA0B,CACxB,IAAAhB,4BAAA,CAAAM,OAAA,MAAI,EAAAD,iBAAA,EAAAA,iBAAA,EAAmBY,KAAK,EAC5B,UAACK,IAAI,EAAEJ,OAAO,EAAK;QACjBA,OAAO,CAACK,oBAAoB,KAAAvB,4BAAA,CAAAM,OAAA,EAACe,MAAI,EAAAb,aAAA,EAAAA,aAAA,CAAc,CAAC;MAClD,CACF,CAAC;IACH;EAAC;IAAAK,GAAA;IAAAjB,KAAA,EAED,SAAO4B,YAAYA,CACjBC,SAAwD,EACxD;MAAA,IAAAC,MAAA;MACA,IAAMC,gBAAgB,GAAG,IAAI,CAACf,eAAe,CAAC,IAAI,CAAC;MAEnD,IAAI,IAAAZ,4BAAA,CAAAM,OAAA,MAAI,EAAAE,aAAA,EAAAA,aAAA,MAAmBmB,gBAAgB,EAAE;QAE3CX,0BAA0B,CAACS,SAAS,EAAE,UAACH,IAAI,EAAEJ,OAAO,EAAK;UACvDA,OAAO,CAACK,oBAAoB,KAAAvB,4BAAA,CAAAM,OAAA,EAACoB,MAAI,EAAAlB,aAAA,EAAAA,aAAA,CAAc,CAAC;QAClD,CAAC,CAAC;QAGF,IAAAR,4BAAA,CAAAM,OAAA,MAAI,EAAAE,aAAA,EAAAA,aAAA,IAAiBmB,gBAAgB;QAErC,IAAI,CAACb,YAAY,CAAC,CAAC;QACnB;MACF;MAEAE,0BAA0B,CAACS,SAAS,EAAE,UAACZ,GAAG,EAAEe,WAAW,EAAK;QAC1D,IAAMC,OAAO,GAAG,IAAA7B,4BAAA,CAAAM,OAAA,EAAAoB,MAAI,EAAArB,iBAAA,EAAAA,iBAAA,EAAmBY,KAAK,CAACJ,GAAG,CAAC;QACjD,IAAI,CAACgB,OAAO,EAAE;UAEZD,WAAW,CAACL,oBAAoB,KAAAvB,4BAAA,CAAAM,OAAA,EAACoB,MAAI,EAAAlB,aAAA,EAAAA,aAAA,CAAc,CAAC;QACtD,CAAC,MAAM,IACLsB,qBAAqB,CAACD,OAAO,CAAC,IAC9BA,OAAO,CAACE,mBAAmB,KAAKH,WAAW,EAC3C;UAEAA,WAAW,CAACL,oBAAoB,KAAAvB,4BAAA,CAAAM,OAAA,EAACoB,MAAI,EAAAlB,aAAA,EAAAA,aAAA,CAAc,CAAC;UACpDqB,OAAO,CAACE,mBAAmB,CAACZ,iBAAiB,KAAAnB,4BAAA,CAAAM,OAAA,EAACoB,MAAI,EAAAlB,aAAA,EAAAA,aAAA,CAAc,CAAC;QACnE;MACF,CAAC,CAAC;MAEFQ,0BAA0B,CAAC,IAAAhB,4BAAA,CAAAM,OAAA,MAAI,EAAAD,iBAAA,EAAAA,iBAAA,EAAmBY,KAAK,EAAE,UAACJ,GAAG,EAAEK,OAAO,EAAK;QACzE,IAAI,CAACO,SAAS,CAACZ,GAAG,CAAC,EAAE;UAEnBK,OAAO,CAACC,iBAAiB,KAAAnB,4BAAA,CAAAM,OAAA,EAACoB,MAAI,EAAAlB,aAAA,EAAAA,aAAA,CAAc,CAAC;QAC/C;MACF,CAAC,CAAC;IACJ;EAAC;IAAAK,GAAA;IAAAjB,KAAA,EAED,SAAQgB,eAAeA,CAAA,EAAmC;MAAA,IAAAoB,qBAAA,EAAAC,gBAAA;MAAA,IAAlCC,eAAwB,GAAAC,SAAA,CAAAC,MAAA,QAAAD,SAAA,QAAAE,SAAA,GAAAF,SAAA,MAAG,KAAK;MAEtD,IAAMG,oBAAoB,GAAG,IAAAtC,4BAAA,CAAAM,OAAA,MAAI,EAAAD,iBAAA,EAAAA,iBAAA,EAC9BkC,aAKF;MACD,IAAID,oBAAoB,CAACE,iBAAiB,EAAE;QAAA,IAAAC,eAAA;QAO1C,IAAMC,cAAc,GAAGJ,oBAAoB,CAACE,iBAAiB,CAAC,CAAC;QAC/D,IAAI,OAAOE,cAAc,KAAK,QAAQ,EAAE;UACtC,OAAOA,cAAc;QACvB;QACA,QAAAD,eAAA,GAAO,IAAAE,+BAAc,EAACD,cAAc,CAAC,YAAAD,eAAA,GAAI,CAAC,CAAC;MAC7C;MACA,KAAAT,qBAAA,OAAAhC,4BAAA,CAAAM,OAAA,EAAI,IAAI,EAAAC,iBAAA,EAAAA,iBAAA,cAAJyB,qBAAA,CAAwBY,cAAc,EAAE;QAAA,IAAAC,gBAAA;QAG1C,QAAAA,gBAAA,GAAO,IAAAF,+BAAc,MAAA3C,4BAAA,CAAAM,OAAA,EAAC,IAAI,EAAAD,iBAAA,EAAAA,iBAAA,CAAkB,CAAC,YAAAwC,gBAAA,GAAI,CAAC,CAAC;MACrD;MACA,IAAI,CAACX,eAAe,EAAE;QAEpB,OAAO,IAAAlC,4BAAA,CAAAM,OAAA,MAAI,EAAAD,iBAAA,EAAAA,iBAAA,EAAmByC,mBAAmB,CAAC,CAAC;MACrD;MACA,IAAIR,oBAAoB,CAACS,WAAW,IAAIT,oBAAoB,CAACU,UAAU,EAAE;QAAA,IAAAC,IAAA,EAAAC,qBAAA;QAMvE,QAAAD,IAAA,IAAAC,qBAAA,GACEZ,oBAAoB,CAACS,WAAW,YAAAG,qBAAA,GAChCZ,oBAAoB,CAACU,UAAU,YAAAC,IAAA,GAC/B,CAAC,CAAC;MAEN;MAKA,QAAAhB,gBAAA,GAAO,IAAAU,+BAAc,EAACL,oBAAoB,CAAC,YAAAL,gBAAA,GAAI,CAAC,CAAC;IACnD;EAAC;AAAA;AAGH,SAASH,qBAAqBA,CAC5BqB,IAAa,EACsB;EACnC,OACE,IAAAC,UAAG,EAAC,qBAAqB,EAAED,IAAI,CAAC,IAChCA,IAAI,CAACpB,mBAAmB,YAAYsB,wCAAmB;AAE3D;AAEA,SAASrC,0BAA0BA,CACjCC,KAAoD,EACpDqC,QAGS,EACT;EACA,KAAK,IAAMzC,GAAG,IAAII,KAAK,EAAE;IACvB,IAAMkC,IAAI,GAAGlC,KAAK,CAACJ,GAAG,CAAC;IACvB,IAAIiB,qBAAqB,CAACqB,IAAI,CAAC,EAAE;MAC/BG,QAAQ,CAACzC,GAAG,EAAEsC,IAAI,CAACpB,mBAAmB,CAAC;IACzC;EACF;AACF","ignoreList":[]}
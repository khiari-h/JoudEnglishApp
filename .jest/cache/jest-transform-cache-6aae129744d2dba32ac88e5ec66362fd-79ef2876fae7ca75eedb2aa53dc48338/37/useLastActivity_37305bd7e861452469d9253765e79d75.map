{"version":3,"names":["_react","require","_asyncStorage","_interopRequireDefault","_constants","useLastActivity","_useState","useState","_useState2","_slicedToArray2","default","lastActivity","setLastActivity","_useState3","_useState4","isLoading","setIsLoading","loadLastActivity","useCallback","_asyncToGenerator2","stored","AsyncStorage","getItem","STORAGE_KEYS","LAST_ACTIVITY","activity","JSON","parse","now","Date","diffInMinutes","Math","floor","timestamp","timeElapsed","hours","days","Object","assign","error","console","saveActivity","_ref2","activityData","setItem","stringify","emit","eventBusError","warn","_x","apply","arguments","clearActivity","removeItem","useEffect","reload","_default","exports"],"sources":["useLastActivity.js"],"sourcesContent":["// src/hooks/useLastActivity.js - VERSION CORRIGÉE AVEC useCallback\nimport { useState, useEffect, useCallback } from 'react';\nimport AsyncStorage from '@react-native-async-storage/async-storage';\nimport { STORAGE_KEYS } from '../utils/constants';\n\nconst useLastActivity = () => {\n  const [lastActivity, setLastActivity] = useState(null);\n  const [isLoading, setIsLoading] = useState(true);\n\n  // ========== CHARGEMENT ==========\n  const loadLastActivity = useCallback(async () => {\n    try {\n      setIsLoading(true);\n      const stored = await AsyncStorage.getItem(STORAGE_KEYS.LAST_ACTIVITY);\n      \n      if (stored) {\n        const activity = JSON.parse(stored);\n        \n        // Calculer temps écoulé simple\n        const now = Date.now();\n        const diffInMinutes = Math.floor((now - activity.timestamp) / (1000 * 60));\n        \n        let timeElapsed = \"À l'instant\";\n        if (diffInMinutes < 60) {\n          timeElapsed = diffInMinutes === 0 ? \"À l'instant\" : `Il y a ${diffInMinutes} min`;\n        } else if (diffInMinutes < 1440) {\n          const hours = Math.floor(diffInMinutes / 60);\n          timeElapsed = `Il y a ${hours}h`;\n        } else {\n          const days = Math.floor(diffInMinutes / 1440);\n          timeElapsed = `Il y a ${days}j`;\n        }\n        \n        setLastActivity({\n          ...activity,\n          timeElapsed\n        });\n      } else {\n        setLastActivity(null);\n      }\n    } catch (error) {\n      console.error('Erreur chargement dernière activité:', error);\n      setLastActivity(null);\n    } finally {\n      setIsLoading(false);\n    }\n  }, []); // ✅ Aucune dépendance - stable\n\n  // ========== SAUVEGARDE MÉMORISÉE ==========\n  const saveActivity = useCallback(async (activityData) => {\n    try {\n      const activity = {\n        ...activityData,\n        timestamp: Date.now()\n      };\n      \n      await AsyncStorage.setItem(STORAGE_KEYS.LAST_ACTIVITY, JSON.stringify(activity));\n      \n      // Event bus : notifier la progression\n      try { \n        require('../utils/eventBus').emit('progress-updated', activity); \n      } catch(eventBusError) { \n        // ✅ Gestion d'erreur appropriée\n        console.warn('Event bus error (non-critical):', eventBusError);\n      }\n      // Mettre à jour l'état local avec temps écoulé\n      setLastActivity({\n        ...activity,\n        timeElapsed: \"À l'instant\"\n      });\n    } catch (error) {\n      console.error('Erreur sauvegarde activité:', error);\n    }\n  }, []); // ✅ CRUCIAL : Aucune dépendance - fonction stable\n\n  // ========== SUPPRESSION MÉMORISÉE ==========\n  const clearActivity = useCallback(async () => {\n    try {\n      await AsyncStorage.removeItem(STORAGE_KEYS.LAST_ACTIVITY);\n      setLastActivity(null);\n    } catch (error) {\n      console.error('Erreur suppression activité:', error);\n    }\n  }, []); // ✅ Fonction stable\n\n  // ========== CHARGEMENT INITIAL ==========\n  useEffect(() => {\n    loadLastActivity();\n  }, [loadLastActivity]);\n\n  return {\n    lastActivity,\n    isLoading,\n    saveActivity, // ✅ Maintenant stable entre les renders\n    clearActivity, // ✅ Maintenant stable\n    reload: loadLastActivity // ✅ Maintenant stable\n  };\n};\n\nexport default useLastActivity;"],"mappings":"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","ignoreList":[]}
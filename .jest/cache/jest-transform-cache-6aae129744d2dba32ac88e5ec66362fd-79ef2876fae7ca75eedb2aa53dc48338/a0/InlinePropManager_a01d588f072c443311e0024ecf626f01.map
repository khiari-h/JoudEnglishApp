{"version":3,"names":["_interopRequireDefault","require","Object","defineProperty","exports","value","InlinePropManager","getInlineStyle","hasInlineStyles","_classCallCheck2","_createClass2","_slicedToArray2","_utils","_ViewDescriptorsSet","_ConfigHelper","_UpdateProps","_mappers","_isSharedValue","isInlineStyleTransform","transform","Array","isArray","some","t","inlinePropsHasChanged","styles1","styles2","keys","length","key","_worklet_4079464443542_init_data","code","location","sourceMap","version","getInlinePropsUpdate","_e","global","Error","_getInlinePropsUpdate","inlineProps","update","_ref","entries","_ref2","default","styleValue","isSharedValue","map","item","__closure","__workletHash","__initData","__stackDetails","extractSharedValuesMapFromProps","props","_props$style","styles","flattenArray","style","forEach","_ref3","_ref4","styleKey","isFirstRender","newStyle","_ref5","_ref6","_worklet_8214641554132_init_data","_inlinePropsViewDescriptors","_inlinePropsMapperId","_inlineProps","attachInlineProps","animatedComponent","viewInfo","newInlineProps","hasChanged","makeViewDescriptorsSet","viewTag","viewName","shadowNodeWrapper","viewConfig","adaptViewConfig","add","tag","name","shareableViewDescriptors","updaterFunction","InlinePropManagerTs2","updateProps","stopMapper","startMapper","values","detachInlineProps"],"sources":["InlinePropManager.ts"],"sourcesContent":["'use strict';\nimport type { StyleProps } from '../commonTypes';\nimport type {\n  IAnimatedComponentInternal,\n  AnimatedComponentProps,\n  IInlinePropManager,\n  ViewInfo,\n} from './commonTypes';\nimport { flattenArray } from './utils';\nimport { makeViewDescriptorsSet } from '../ViewDescriptorsSet';\nimport type { ViewDescriptorsSet } from '../ViewDescriptorsSet';\nimport { adaptViewConfig } from '../ConfigHelper';\nimport updateProps from '../UpdateProps';\nimport { stopMapper, startMapper } from '../mappers';\nimport { isSharedValue } from '../isSharedValue';\n\nfunction isInlineStyleTransform(transform: unknown): boolean {\n  if (!Array.isArray(transform)) {\n    return false;\n  }\n\n  return transform.some((t: Record<string, unknown>) => hasInlineStyles(t));\n}\n\nfunction inlinePropsHasChanged(\n  styles1: StyleProps,\n  styles2: StyleProps\n): boolean {\n  if (Object.keys(styles1).length !== Object.keys(styles2).length) {\n    return true;\n  }\n\n  for (const key of Object.keys(styles1)) {\n    if (styles1[key] !== styles2[key]) {\n      return true;\n    }\n  }\n\n  return false;\n}\n\nfunction getInlinePropsUpdate(inlineProps: Record<string, unknown>) {\n  'worklet';\n  const update: Record<string, unknown> = {};\n  for (const [key, styleValue] of Object.entries(inlineProps)) {\n    if (isSharedValue(styleValue)) {\n      update[key] = styleValue.value;\n    } else if (Array.isArray(styleValue)) {\n      update[key] = styleValue.map((item) => {\n        return getInlinePropsUpdate(item);\n      });\n    } else if (typeof styleValue === 'object') {\n      update[key] = getInlinePropsUpdate(styleValue as Record<string, unknown>);\n    } else {\n      update[key] = styleValue;\n    }\n  }\n  return update;\n}\n\nfunction extractSharedValuesMapFromProps(\n  props: AnimatedComponentProps<\n    Record<string, unknown> /* Initial component props */\n  >\n): Record<string, unknown> {\n  const inlineProps: Record<string, unknown> = {};\n\n  for (const key in props) {\n    const value = props[key];\n    if (key === 'style') {\n      const styles = flattenArray<StyleProps>(props.style ?? []);\n      styles.forEach((style) => {\n        if (!style) {\n          return;\n        }\n        for (const [styleKey, styleValue] of Object.entries(style)) {\n          if (isSharedValue(styleValue)) {\n            inlineProps[styleKey] = styleValue;\n          } else if (\n            styleKey === 'transform' &&\n            isInlineStyleTransform(styleValue)\n          ) {\n            inlineProps[styleKey] = styleValue;\n          }\n        }\n      });\n    } else if (isSharedValue(value)) {\n      inlineProps[key] = value;\n    }\n  }\n\n  return inlineProps;\n}\n\nexport function hasInlineStyles(style: StyleProps): boolean {\n  if (!style) {\n    return false;\n  }\n  return Object.keys(style).some((key) => {\n    const styleValue = style[key];\n    return (\n      isSharedValue(styleValue) ||\n      (key === 'transform' && isInlineStyleTransform(styleValue))\n    );\n  });\n}\n\nexport function getInlineStyle(\n  style: Record<string, unknown>,\n  isFirstRender: boolean\n) {\n  if (isFirstRender) {\n    return getInlinePropsUpdate(style);\n  }\n  const newStyle: StyleProps = {};\n  for (const [key, styleValue] of Object.entries(style)) {\n    if (\n      !isSharedValue(styleValue) &&\n      !(key === 'transform' && isInlineStyleTransform(styleValue))\n    ) {\n      newStyle[key] = styleValue;\n    }\n  }\n  return newStyle;\n}\n\nexport class InlinePropManager implements IInlinePropManager {\n  _inlinePropsViewDescriptors: ViewDescriptorsSet | null = null;\n  _inlinePropsMapperId: number | null = null;\n  _inlineProps: StyleProps = {};\n\n  public attachInlineProps(\n    animatedComponent: React.Component<unknown, unknown> &\n      IAnimatedComponentInternal,\n    viewInfo: ViewInfo\n  ) {\n    const newInlineProps: Record<string, unknown> =\n      extractSharedValuesMapFromProps(animatedComponent.props);\n    const hasChanged = inlinePropsHasChanged(newInlineProps, this._inlineProps);\n\n    if (hasChanged) {\n      if (!this._inlinePropsViewDescriptors) {\n        this._inlinePropsViewDescriptors = makeViewDescriptorsSet();\n\n        const { viewTag, viewName, shadowNodeWrapper, viewConfig } = viewInfo;\n\n        if (Object.keys(newInlineProps).length && viewConfig) {\n          adaptViewConfig(viewConfig);\n        }\n\n        this._inlinePropsViewDescriptors.add({\n          tag: viewTag as number,\n          name: viewName!,\n          shadowNodeWrapper: shadowNodeWrapper!,\n        });\n      }\n      const shareableViewDescriptors =\n        this._inlinePropsViewDescriptors.shareableViewDescriptors;\n\n      const updaterFunction = () => {\n        'worklet';\n        const update = getInlinePropsUpdate(newInlineProps);\n        updateProps(shareableViewDescriptors, update);\n      };\n      this._inlineProps = newInlineProps;\n      if (this._inlinePropsMapperId) {\n        stopMapper(this._inlinePropsMapperId);\n      }\n      this._inlinePropsMapperId = null;\n      if (Object.keys(newInlineProps).length) {\n        this._inlinePropsMapperId = startMapper(\n          updaterFunction,\n          Object.values(newInlineProps)\n        );\n      }\n    }\n  }\n\n  public detachInlineProps() {\n    if (this._inlinePropsMapperId) {\n      stopMapper(this._inlinePropsMapperId);\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]}